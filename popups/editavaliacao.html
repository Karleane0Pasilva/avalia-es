<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editar Avaliação</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- CSS global -->
  <link rel="stylesheet" href="../css/style.css">

  <!-- Quill -->
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>

  <!-- Supabase -->
  <script type="module" src="../js/supabase.js"></script>

</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

  <!-- CONTAINER -->
  <div class="bg-white w-full max-w-5xl rounded-xl shadow-xl p-8 relative">

    <!-- FECHAR -->
    <button onclick="window.location.href='../perfil.html'"
            class="absolute top-4 right-4 text-gray-600 hover:text-gray-800 text-2xl">×</button>

    <div class="flex gap-8">

      <!-- COLUNA ESQUERDA -->
      <div class="w-1/3 flex flex-col items-center">

        <!-- CAPA -->
        <div class="w-full aspect-[3/4] bg-gray-200 rounded flex items-center justify-center overflow-hidden mb-4">
          <img id="capaLivro" src="" class="w-full h-full object-cover hidden">
          <span id="capaPlaceholder" class="text-gray-500">CAPA</span>
        </div>

        <!-- NOME DO LIVRO -->
        <div id="tituloLivro"
             class="w-full bg-gray-100 text-center py-2 rounded text-sm font-semibold text-gray-700 mb-4">
          TÍTULO DO LIVRO
        </div>

      </div>

      <!-- COLUNA DIREITA -->
      <div class="w-2/3 flex flex-col">

        <!-- TÍTULO + ESTRELAS -->
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">EDITAR AVALIAÇÃO</h2>

          <div id="estrelas" class="flex gap-1 text-2xl text-gray-300 cursor-pointer">
            <span data-valor="1">★</span>
            <span data-valor="2">★</span>
            <span data-valor="3">★</span>
            <span data-valor="4">★</span>
            <span data-valor="5">★</span>
          </div>
        </div>

        <!-- QUILL -->
        <div id="toolbar-av" class="border border-gray-300 border-b-0 bg-gray-50 rounded-t"></div>

        <div id="editor-av" class="h-64 border border-gray-300 rounded-b bg-white mb-6"></div>

        <!-- BOTÃO SALVAR -->
        <div class="flex justify-end">
          <button id="salvarEdicao"
                  class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-semibold">
            SALVAR
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast"
       class="fixed bottom-6 right-6 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg opacity-0 pointer-events-none transition-all duration-300">
  </div>

  <!-- SCRIPT -->
  <script type="module">
    import { supabase } from '../js/supabase.js'

    const params = new URLSearchParams(window.location.search)
    const avaliacaoId = params.get("id")

    let notaSelecionada = 0
    let livroData = null

    // QUILL
    const quill = new Quill('#editor-av', {
      theme: 'snow',
      placeholder: 'Edite sua avaliação...',
      modules: {
        toolbar: [
          [{ 'header': [1, 2, false] }],
          [{ 'font': [] }],
          ['bold', 'italic', 'underline'],
          [{ 'list': 'ordered' }, { 'list': 'bullet' }],
          [{ 'align': [] }]
        ]
      }
    })

    // TOAST
    function toast(msg) {
      const t = document.getElementById('toast')
      t.textContent = msg
      t.classList.remove('opacity-0')
      t.classList.add('opacity-100')

      setTimeout(() => {
        t.classList.add('opacity-0')
        t.classList.remove('opacity-100')
      }, 2500)
    }

    // CARREGAR DADOS DA AVALIAÇÃO
    async function carregarAvaliacao() {

      const { data, error } = await supabase
        .from('avaliacoes')
        .select(`
          id,
          nota,
          descricao,
          livros (id, titulo, capa)
        `)
        .eq('id', avaliacaoId)
        .single()

      if (error || !data) {
        toast("Erro ao carregar avaliação.")
        return
      }

      livroData = data.livros

      // CAPA
      const capa = document.getElementById('capaLivro')
      const placeholder = document.getElementById('capaPlaceholder')

      if (livroData.capa) {
        capa.src = livroData.capa
        capa.classList.remove('hidden')
        placeholder.classList.add('hidden')
      }

      // TÍTULO
      document.getElementById('tituloLivro').textContent = livroData.titulo

      // TEXTO
      quill.root.innerHTML = data.descricao

      // ESTRELAS
      notaSelecionada = data.nota
      atualizarEstrelas()
    }

    carregarAvaliacao()

    // SISTEMA DE ESTRELAS
    function atualizarEstrelas() {
      document.querySelectorAll('#estrelas span').forEach(s => {
        const val = Number(s.dataset.valor)
        if (val <= notaSelecionada) {
          s.classList.add('text-yellow-400')
          s.classList.remove('text-gray-300')
        } else {
          s.classList.add('text-gray-300')
          s.classList.remove('text-yellow-400')
        }
      })
    }

    document.querySelectorAll('#estrelas span').forEach(star => {
      star.addEventListener('click', () => {
        notaSelecionada = Number(star.dataset.valor)
        atualizarEstrelas()
      })
    })

    // SALVAR EDIÇÃO
    document.getElementById('salvarEdicao').addEventListener('click', async () => {

      const descricaoAtualizada = quill.root.innerHTML.trim()

      const { error } = await supabase
        .from('avaliacoes')
        .update({
          descricao: descricaoAtualizada,
          nota: notaSelecionada,
          data: new Date()
        })
        .eq('id', avaliacaoId)

      if (error) {
        toast("Erro ao salvar.")
        return
      }

      toast("Avaliação atualizada!")

      setTimeout(() => {
        window.location.href = "../perfil.html"
      }, 800)
    })
  </script>

</body>
</html>
